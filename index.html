<!doctype html>
<html lang="en">
<head>
	<meta charset="UTF-8" />
    <title>Clashes of Stars</title>
	<script type="text/javascript" src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
    <script type="text/javascript" src="lib/phaser.min.js"></script>
    <script src="lib/HealthBar.standalone.js"></script>
    <script type="text/javascript" src="logic/bullets.js"></script>
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>
<body>

<script type="text/javascript">

var height = $(document).height();
var width = $(document).width();

var game = new Phaser.Game(width, height, Phaser.AUTO, '', { preload: preload, create: create, update: update });
var myHealthBar;


function preload() {
    game.load.image('background', 'assets/asteroidBack.png', 2273, 1304);
    game.load.image('space', 'assets/space.jpg', 2273, 1304);

    game.load.atlasJSONHash('bot', 'assets/running_bot/view.png', 'assets/running_bot/logic.json');
    game.load.atlasJSONHash('machine_gun', 'assets/machine_gun/view.png', 'assets/machine_gun/logic.json');
    game.load.atlasJSONHash('sentry_gun', 'assets/sentry_gun/view.png', 'assets/sentry_gun/logic.json');
    game.load.atlasJSONHash('rocket', 'assets/rocket/view.png', 'assets/rocket/logic.json');
    game.load.atlasJSONHash('soldier', 'assets/soldier/sprites.png', 'assets/soldier/sprites.js');
    game.load.atlasJSONHash('fly_unit', 'assets/fly_unit/sprites.png', 'assets/fly_unit/sprites.js');


    game.load.spritesheet('lab', 'assets/lab/view.png', 180, 149);
    game.load.spritesheet('farm', 'assets/farm/view.png', 180, 149);
    game.load.spritesheet('craft', 'assets/craft/view.png', 180, 149);
    game.load.spritesheet('oreStore', 'assets/oreStore/view.png', 180, 149);
    game.load.spritesheet('miner', 'assets/miner/view.png', 180, 138);
    game.load.spritesheet('HQ', 'assets/HQ/view.png', 180, 138);

    game.load.spritesheet('baddie', 'assets/baddie.png', 32, 32);
    game.load.spritesheet('dude', 'assets/dude.png', 32, 48);


    // Bullets loading up
    for (var i = 1; i <= 11; i++)
    {
        game.load.image('bullet' + i, 'assets/bullets/bullet' + i + '.png');
    }
}

var player;
var cursors;
var lastKey = 'right';

var countKiller = 0;
var stars;
var scorePlayer = 0;
var scoreDog = 0;
var scoreText;
var start = false;
var robot;
var state;
var levels = [{ buildings:{HQ:1, miner: 2, oreStore: 4, craft: 5, lab: 2, farm: 4}, hostiles:{ soldier: 2, fly_unit: 3} ,defenses:{rocket: 1, sentry_gun: 1}},
              { buildings:{HQ:1, miner: 2, oreStore: 4, craft: 5, lab: 2, farm: 4}, hostiles:{ soldier: 4} ,defenses:{rocket: 4, sentry_gun: 5}}
             ]
var defenses = [];
var buildings = [];
var hostiles = [];
var aBot;


function checkFrame(anim) {
    var weaponAngle = parseInt(anim.currentFrame.name.replace('Spinning__', ''));
    // TODO: El ordering tendria que estar en el arma y no en la bala
    anim._parent.bulletType.fire(anim._parent, anim._parent.bulletType.weaponOrdering[weaponAngle-1]);
}

function createSprite(x,y, sprite, bulletType) {
    var s =game.add.sprite(x, y , sprite);
    s.scale.setTo(0.5, 0.5);
    var anim = s.animations.add('spinning', Phaser.Animation.generateFrameNames('Spinning__', 1, 8, '', 3), 40, false, false);
    anim.enableUpdate = true;
    anim.onUpdate.add(checkFrame, anim);
    s.play('spinning', 10, true);
    s.bulletType = bulletType;
    s.enableBody = true;
    s.checkWorldBounds = true;
    var barConfig = {x: x, y: y, width: 50, height: 10, flipped: false, bar: {
      color: '#0000FF'
    },};
    myHealthBar = new HealthBar(game, barConfig);
    myHealthBar.setPercent(0);
    s.healthbar = myHealthBar;
    s.health = 0;
    game.physics.arcade.enable(s);
    s.body.immovable = true;
    return s;
}

function createBuilding(x,y, name) {
    var s = game.add.sprite(x, y , name);
    s.scale.setTo(0.5, 0.5);
    var barConfig = {x: x, y: y, width: 50, height: 10, flipped: false, bar: {
      color: '#00FF00'
    },};
    myHealthBar = new HealthBar(game, barConfig);
    myHealthBar.setPercent(0);
    s.healthbar = myHealthBar;
    s.health = 0;
    game.physics.arcade.enable(s);
    s.body.collideWorldBounds = true;
    s.body.allowRotation = true;
    s.body.bounce.y = 0.3;
    s.body.bounce.x = 0.5;
    s.body.collideWorldBounds = true;
    s.body.immovable = true;

    return s;
}

function createLevel(number) {
   var currentLevel = levels[number];
   var background = game.add.sprite(0, 0, 'background');
   background.scale.setTo(0.6, 0.6);
   for (var key in currentLevel.buildings) {
       for (var i=0; i< currentLevel.buildings[key]; i++)
           buildings.push(createBuilding(game.world.randomX, game.world.randomY, key));
   }
   var gun;
   for (var key in currentLevel.defenses) {
       // TODO Crear el tipo Weapon y meter el tipo de bullet ahi
       for (var i=0; i< currentLevel.defenses[key]; i++){
           if (key === 'sentry_gun')
               gun = new Weapon.SingleBullet(game);
           else
               gun = new Weapon.Rockets(game)
           defenses.push(createSprite(game.world.randomX, game.world.randomY, key, gun));
       }
   }
   // hostiles
   for (var key in currentLevel.hostiles) {
       if (key === 'soldier')
           for (var i=0; i< currentLevel.hostiles[key]; i++)
               hostiles.push(createSoldier(game.world.randomX, game.world.randomY));
       else {
            for (var i=0; i< currentLevel.hostiles[key]; i++)
               hostiles.push(createFlyUnit(game.world.randomX, game.world.randomY));
       }
   }
}

function createRobot(x,y,weapon){
    var s =game.add.sprite(x, y, 'bot');
    s.scale.setTo(0.6, 0.6);

    s.animations.add('run');
    s.animations.play('run', 10, true);
    game.physics.arcade.enable(s);

    s.body.collideWorldBounds = true;
    s.body.allowRotation = true;
    s.gun = weapon;
    s.health = 0;
    var barConfig = {x: x, y: y, width: 50, height: 10, flipped: false};
    myHealthBar = new HealthBar(game, barConfig);
    myHealthBar.setPercent(0);
    s.healthbar = myHealthBar;
    return s;
}


function createSoldier(x,y){
    var s =game.add.sprite(x, y, 'soldier');
    s.scale.setTo(1.0, 1.0);
    animation = [];
    for (i=0;i<104;i++)
        animation.push(i);

    s.animations.add('position1', animation, 10, true);
    s.animations.play('position1', 10, true);
    game.physics.arcade.enable(s);

    s.body.collideWorldBounds = true;
    s.body.allowRotation = true;
    s.health = 0;
    var barConfig = {x: x, y: y-10, width: 50, height: 10, flipped: false, bar: {
      color: '#FFFF00'
    }};
    myHealthBar = new HealthBar(game, barConfig);
    myHealthBar.setPercent(0);
    s.healthbar = myHealthBar;
    return s;
}

function createFlyUnit(x,y){
    var s =game.add.sprite(x, y, 'fly_unit');
    s.scale.setTo(1.0, 1.0);
    animation = [];
    for (i=0;i<14;i++)
        animation.push(i);

    s.animations.add('position1', animation, 10, true);
    s.animations.play('position1', 10, true);
    game.physics.arcade.enable(s);

    s.body.collideWorldBounds = true;
    s.body.allowRotation = true;
    s.health = 0;
    var barConfig = {x: x, y: y-10, width: 50, height: 10, flipped: false, bar: {
      color: '#FFFF00'
    }};
    myHealthBar = new HealthBar(game, barConfig);
    myHealthBar.setPercent(0);
    s.healthbar = myHealthBar;
    return s;
}



function create() {

    //  We're going to be using physics, so enable the Arcade Physics system
    game.physics.startSystem(Phaser.Physics.ARCADE);
    createLevel(0);
    robot = createRobot(100, 100, new Weapon.SingleBullet(game));
    cursors = game.input.keyboard.createCursorKeys();


}

/*function create() {

    //  We're going to be using physics, so enable the Arcade Physics system
    game.physics.startSystem(Phaser.Physics.ARCADE);
    aBot = game.add.sprite(0, 50 , 'dude');
    game.physics.arcade.enable(aBot);
    aBot.body.immovable = true;

    robot = game.add.sprite(0, 100 , 'baddie');
    game.physics.arcade.enable(robot);

    robot.body.bounce.y = 0.3;
    robot.body.collideWorldBounds = true;

    aBot.body.bounce.y = 0.3;
    aBot.body.collideWorldBounds = true;

    cursors = game.input.keyboard.createCursorKeys();

}*/

var wasLeft = 1;
var wasRight = -1;
var angle = 180;

function controlRobot(){
        if (game.input.keyboard.isDown(Phaser.Keyboard.LEFT))
        {
            robot.body.velocity.x = -40;
            if (wasRight)
                robot.scale.x *= -1;
            wasLeft = true;
            wasRight = false;
            angle = 180;
        }
        else if (game.input.keyboard.isDown(Phaser.Keyboard.RIGHT))
        {
            robot.body.velocity.x = 40;
            if (wasLeft)
                robot.scale.x *= -1;
            wasRight = true;
            wasLeft = false;
            angle = 0;
        }

        if (game.input.keyboard.isDown(Phaser.Keyboard.UP))
        {
            robot.body.velocity.y = -40;
        }
        else if (game.input.keyboard.isDown(Phaser.Keyboard.DOWN))
        {
            robot.body.velocity.y = 40;
        }
        if (game.input.keyboard.isDown(Phaser.Keyboard.SPACEBAR))
        {
            robot.gun.fire(robot, angle);
        }
        if (robot.healthbar)
            robot.healthbar.setPosition(robot.x, robot.y - 10);
        robot.frame = 4;
}


function shootYou(player, bulletType) {
    if (player.health < 100) {
        player.health += bulletType.parent.damageRate;
        player.healthbar.setPercent(player.health);
        bulletType.kill();
    } else {
        player.healthbar.clear();
        player.kill();
        location.reload();
    }
}


function killStructure(structure, player){
    if (structure.health < 100) {
        structure.health += player.parent.damageRate;
        structure.healthbar.setPercent(structure.health);
    } else {
        structure.healthbar.clear();
        structure.kill();
    }
    player.kill();
}

function checkCollide() {
    console.log('collide');
}

function update() {
    for (defense in defenses){
        game.physics.arcade.collide(robot, defenses[defense], checkCollide);
        game.physics.arcade.overlap(robot, defenses[defense].bulletType, shootYou, null, this);
        game.physics.arcade.overlap(defenses[defense], robot.gun, killStructure, null, this);
    }
    for (building in buildings){
        game.physics.arcade.collide(robot, buildings[building], checkCollide);
        game.physics.arcade.overlap(buildings[building], robot.gun, killStructure, null, this);
    }
    for (hostile in hostiles){
        game.physics.arcade.overlap(hostiles[hostile], robot.gun, killStructure, null, this);
    }
    controlRobot();
}

/*function update() {
    game.physics.arcade.collide(aBot, robot, checkCollide);
    controlRobot();
}*/


</script>

</body>
</html>
