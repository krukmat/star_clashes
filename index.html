<!doctype html>
<html lang="en">
<head>
	<meta charset="UTF-8" />
    <title>Phaser - Making your first game, part 9</title>
	<script type="text/javascript" src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
    <script type="text/javascript" src="lib/phaser.min.js"></script>
    <script type="text/javascript" src="logic/bullets.js"></script>
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>
<body>

<script type="text/javascript">

var height = $(document).height();
var width = $(document).width();

var game = new Phaser.Game(width, height, Phaser.AUTO, '', { preload: preload, create: create, update: update });



function preload() {
    game.load.image('background', 'assets/asteroidBack.png', 2273, 1304);
    game.load.image('space', 'assets/space.jpg', 2273, 1304);

    game.load.atlasJSONHash('bot', 'assets/running_bot/view.png', 'assets/running_bot/logic.json');
    game.load.atlasJSONHash('machine_gun', 'assets/machine_gun/view.png', 'assets/machine_gun/logic.json');
    game.load.atlasJSONHash('sentry_gun', 'assets/sentry_gun/view.png', 'assets/sentry_gun/logic.json');
    game.load.atlasJSONHash('rocket', 'assets/rocket/view.png', 'assets/rocket/logic.json');

    game.load.spritesheet('lab', 'assets/lab/view.png', 180, 149);
    game.load.spritesheet('farm', 'assets/farm/view.png', 180, 149);
    game.load.spritesheet('craft', 'assets/craft/view.png', 180, 149);
    game.load.spritesheet('oreStore', 'assets/oreStore/view.png', 180, 149);
    game.load.spritesheet('miner', 'assets/miner/view.png', 180, 138);
    game.load.spritesheet('HQ', 'assets/HQ/view.png', 180, 138);


    // Bullets loading up
    for (var i = 1; i <= 11; i++)
    {
        this.load.image('bullet' + i, 'assets/bullets/bullet' + i + '.png');
    }
}

var player;
var platforms;
var cursors;
var lastKey = 'right';

var countKiller = 0;
var stars;
var scorePlayer = 0;
var scoreDog = 0;
var scoreText;
var start = false;
var robot;
var state;

function createRobot(x,y,weapon){
    var s =game.add.sprite(x, y, 'bot');
    s.scale.setTo(0.6, 0.6);

    s.animations.add('run');
    s.animations.play('run', 10, true);
    game.physics.arcade.enable(s);
    s.body.collideWorldBounds = true;
    s.gun = weapon;
    return s;
}

function checkFrame(anim) {
    var weaponAngle = parseInt(anim.currentFrame.name.replace('Spinning__', ''));
    anim._parent.bulletType.fire(anim._parent, anim._parent.bulletType.weaponOrdering[weaponAngle-1]);
}

function shootYou(player, bulletType) {
    robot.kill();
}

function createSprite(x,y, sprite, bulletType) {
    var s =game.add.sprite(x, y , sprite);
    s.scale.setTo(0.5, 0.5);
    var anim = s.animations.add('spinning', Phaser.Animation.generateFrameNames('Spinning__', 1, 8, '', 3), 40, false, false);
    anim.enableUpdate = true;
    anim.onUpdate.add(checkFrame, anim);
    s.animations.add('180', Phaser.Animation.generateFrameNames('Spinning__', 1, 1, '', 3), 40, false, false); // 180º
    s.animations.add('135', Phaser.Animation.generateFrameNames('Spinning__', 2, 2, '', 3), 40, false, false); // 135º
    s.animations.add('90', Phaser.Animation.generateFrameNames('Spinning__', 3, 3, '', 3), 40, false, false); // 90º
    s.animations.add('45', Phaser.Animation.generateFrameNames('Spinning__', 4, 4, '', 3), 40, false, false); // 45º
    s.animations.add('0', Phaser.Animation.generateFrameNames('Spinning__', 5, 5, '', 3), 40, false, false); // 0º
    s.animations.add('315', Phaser.Animation.generateFrameNames('Spinning__', 6, 6, '', 3), 40, false, false); // 315º
    s.animations.add('270', Phaser.Animation.generateFrameNames('Spinning__', 7, 7, '', 3), 40, false, false); // 270º
    s.animations.add('225', Phaser.Animation.generateFrameNames('Spinning__', 8, 8, '', 3), 40, false, false); // 225º
    s.play('spinning', 10, true);
    s.bulletType = bulletType;
    s.enableBody = true;
    s.checkWorldBounds = true;
    game.physics.arcade.enable(s);
    return s;
}

function createBuilding(x,y, name) {
    var s = game.add.sprite(x, y , name);
    s.scale.setTo(0.5, 0.5);
    s.enableBody = true;
    s.checkWorldBounds = true;
    game.physics.arcade.enable(s);
    return s;
}

function create() {

    //  We're going to be using physics, so enable the Arcade Physics system
    game.physics.startSystem(Phaser.Physics.ARCADE);

    //  A simple background for our game
    var background = game.add.sprite(0, 0, 'background');
    background.scale.setTo(0.6, 0.6);

    robot = createRobot(400, 300, new Weapon.SingleBullet(game));
    //machine = createSprite(100, 400, 'machine_gun', new Weapon.SingleBullet(game));
    sentry = createSprite(300, 500, 'sentry_gun', new Weapon.SingleBullet(game));
    rocket = createSprite(300, 400, 'rocket', new Weapon.Rockets(game));
    lab = createBuilding(40,250, 'lab');
    farm = createBuilding(40, 400, 'farm');
    craft = createBuilding(40, 100, 'craft');
    oreStore = createBuilding(40, 120, 'oreStore');
    miner = createBuilding(40, 200, 'miner');
    hq = createBuilding(40, 300, 'HQ');


    //  Our controls.
    cursors = game.input.keyboard.createCursorKeys();

}

function controlRobot(){
        if (game.input.keyboard.isDown(Phaser.Keyboard.LEFT))
        {
            robot.x -= 4;
        }
        else if (game.input.keyboard.isDown(Phaser.Keyboard.RIGHT))
        {
            robot.x += 4;
        }

        if (game.input.keyboard.isDown(Phaser.Keyboard.UP))
        {
            robot.y -= 4;
        }
        else if (game.input.keyboard.isDown(Phaser.Keyboard.DOWN))
        {
            robot.y += 4;
        }
        if (game.input.keyboard.isDown(Phaser.Keyboard.SPACEBAR))
        {
            robot.gun.fire(robot, 180);
        }
}

function killStructure(structure, player){
    structure.kill();
}

function update() {
    game.physics.arcade.overlap(robot, rocket.bulletType, shootYou, null, this);
    game.physics.arcade.overlap(robot, sentry.bulletType, shootYou, null, this);
    game.physics.arcade.overlap(sentry, robot.gun, killStructure, null, this);
    game.physics.arcade.overlap(rocket, robot.gun, killStructure, null, this);
    game.physics.arcade.overlap(farm, robot.gun, killStructure, null, this);
    game.physics.arcade.overlap(lab, robot.gun, killStructure, null, this);
    game.physics.arcade.overlap(craft, robot.gun, killStructure, null, this);
    game.physics.arcade.overlap(oreStore, robot.gun, killStructure, null, this);
    game.physics.arcade.overlap(miner, robot.gun, killStructure, null, this);
    game.physics.arcade.overlap(hq, robot.gun, killStructure, null, this);
    controlRobot();
}


</script>

</body>
</html>
