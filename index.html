<!doctype html>
<html lang="en">
<head>
	<meta charset="UTF-8" />
    <title>Clashes of Stars</title>
	<script type="text/javascript" src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
    <script type="text/javascript" src="lib/phaser.min.js"></script>
    <script src="lib/HealthBar.standalone.js"></script>
    <script type="text/javascript" src="logic/bullets.js"></script>
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>
<body>

<script type="text/javascript">

var height = $(document).height();
var width = $(document).width();

var game = new Phaser.Game(width, height, Phaser.AUTO, '', { preload: preload, create: create, update: update });
var myHealthBar;


function preload() {
    game.load.image('background', 'assets/asteroidBack.png', 2273, 1304);
    game.load.image('space', 'assets/space.jpg', 2273, 1304);

    game.load.atlasJSONHash('bot', 'assets/running_bot/view.png', 'assets/running_bot/logic.json');
    game.load.atlasJSONHash('machine_gun', 'assets/machine_gun/view.png', 'assets/machine_gun/logic.json');
    game.load.atlasJSONHash('sentry_gun', 'assets/sentry_gun/view.png', 'assets/sentry_gun/logic.json');
    game.load.atlasJSONHash('rocket', 'assets/rocket/view.png', 'assets/rocket/logic.json');

    game.load.spritesheet('lab', 'assets/lab/view.png', 180, 149);
    game.load.spritesheet('farm', 'assets/farm/view.png', 180, 149);
    game.load.spritesheet('craft', 'assets/craft/view.png', 180, 149);
    game.load.spritesheet('oreStore', 'assets/oreStore/view.png', 180, 149);
    game.load.spritesheet('miner', 'assets/miner/view.png', 180, 138);
    game.load.spritesheet('HQ', 'assets/HQ/view.png', 180, 138);


    // Bullets loading up
    for (var i = 1; i <= 11; i++)
    {
        this.load.image('bullet' + i, 'assets/bullets/bullet' + i + '.png');
    }
}

var player;
var cursors;
var lastKey = 'right';

var countKiller = 0;
var stars;
var scorePlayer = 0;
var scoreDog = 0;
var scoreText;
var start = false;
var robot;
var state;
var levels = [{ buildings:{HQ:1, miner: 2, oreStore: 4, craft: 5, lab: 2, farm: 4}, defenses:{rocket: 1, sentry_gun: 1}},
              { buildings:{HQ:1, miner: 2, oreStore: 4, craft: 5, lab: 2, farm: 4}, defenses:{rocket: 4, sentry_gun: 5}}
             ]
var defenses = [];
var buildings = []

function createRobot(x,y,weapon){
    var s =game.add.sprite(x, y, 'bot');
    s.scale.setTo(0.6, 0.6);

    s.animations.add('run');
    s.animations.play('run', 10, true);
    game.physics.arcade.enable(s);
    s.body.collideWorldBounds = true;
    s.body.allowRotation = true;
    s.gun = weapon;
    s.health = 0;
    return s;
}

function checkFrame(anim) {
    var weaponAngle = parseInt(anim.currentFrame.name.replace('Spinning__', ''));
    // TODO: El ordering tendria que estar en el arma y no en la bala
    anim._parent.bulletType.fire(anim._parent, anim._parent.bulletType.weaponOrdering[weaponAngle-1]);
}

function shootYou(player, bulletType) {
    if (player.health < 100) {
        player.health += 1;
        myHealthBar.setPercent(player.health);
    } else {
        player.kill();
        myHealthBar.clear();
        location.reload();
    }
}

function createSprite(x,y, sprite, bulletType) {
    var s =game.add.sprite(x, y , sprite);
    s.scale.setTo(0.5, 0.5);
    var anim = s.animations.add('spinning', Phaser.Animation.generateFrameNames('Spinning__', 1, 8, '', 3), 40, false, false);
    anim.enableUpdate = true;
    anim.onUpdate.add(checkFrame, anim);
    s.play('spinning', 10, true);
    s.bulletType = bulletType;
    s.enableBody = true;
    s.checkWorldBounds = true;
    game.physics.arcade.enable(s);
    return s;
}

function createBuilding(x,y, name) {
    var s = game.add.sprite(x, y , name);
    s.scale.setTo(0.5, 0.5);
    s.enableBody = true;
    s.checkWorldBounds = true;
    game.physics.arcade.enable(s);
    return s;
}

function createLevel(number) {
   var currentLevel = levels[number];
   var background = game.add.sprite(0, 0, 'background');
   background.scale.setTo(0.6, 0.6);
   for (var key in currentLevel.buildings) {
       for (var i=0; i< currentLevel.buildings[key]; i++)
           buildings.push(createBuilding(game.world.randomX, game.world.randomY, key));
   }
   var gun;
   for (var key in currentLevel.defenses) {
       // TODO Crear el tipo Weapon y meter el tipo de bullet ahi
       for (var i=0; i< currentLevel.defenses[key]; i++){
           if (key === 'sentry_gun')
               gun = new Weapon.SingleBullet(game);
           else
               gun = new Weapon.Rockets(game)
           defenses.push(createSprite(game.world.randomX, game.world.randomY, key, gun));
       }
   }
}

function create() {

    //  We're going to be using physics, so enable the Arcade Physics system
    game.physics.startSystem(Phaser.Physics.ARCADE);
    var barConfig = {x: 70, y: 70, width: 50, height: 10, flipped: false};
    createLevel(0);
    myHealthBar = new HealthBar(game, barConfig);
    myHealthBar.setPercent(0);
    robot = createRobot(100, 100, new Weapon.SingleBullet(game));
    cursors = game.input.keyboard.createCursorKeys();

}
var wasLeft = 1;
var wasRight = -1;
var angle = 180;

function controlRobot(){
        if (game.input.keyboard.isDown(Phaser.Keyboard.LEFT))
        {
            robot.x -= 4;
            if (wasRight)
                robot.scale.x *= -1;
            wasLeft = true;
            wasRight = false;
            angle = 180;
        }
        else if (game.input.keyboard.isDown(Phaser.Keyboard.RIGHT))
        {
            robot.x += 4;
            if (wasLeft)
                robot.scale.x *= -1;
            wasRight = true;
            wasLeft = false;
            angle = 0;
        }

        if (game.input.keyboard.isDown(Phaser.Keyboard.UP))
        {
            robot.y -= 4;
        }
        else if (game.input.keyboard.isDown(Phaser.Keyboard.DOWN))
        {
            robot.y += 4;
        }
        if (game.input.keyboard.isDown(Phaser.Keyboard.SPACEBAR))
        {
            robot.gun.fire(robot, angle);
        }
        //myHealthBar.clear();
        myHealthBar.setPosition(robot.x, robot.y - 10);
}

function killStructure(structure, player){
    structure.kill();
}

function update() {
    for (defense in defenses){
        game.physics.arcade.overlap(robot, defenses[defense].bulletType, shootYou, null, this);
        game.physics.arcade.overlap(defenses[defense], robot.gun, killStructure, null, this);
    }
    for (building in buildings){
        game.physics.arcade.overlap(buildings[building], robot.gun, killStructure, null, this);
    }

    controlRobot();
}


</script>

</body>
</html>
